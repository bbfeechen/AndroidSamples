// Copyright (c) 2012 Plenluno All rights reserved.
var namespace=function(e){if(typeof e=="undefined")return window;var t=e.split("."),n=window,r=t.length;for(var i=0;i<r;i++)typeof n[t[i]]=="undefined"&&(n[t[i]]={}),n=n[t[i]];return n};(function(e){var t=function(e){if(!e)throw new Error};e.create=function(){return t}})(typeof exports=="undefined"?namespace("plenluno.orb.util.assert"):exports),Object.defineProperties=function(e,t){for(var n in t)e[n]=t[n].value};var exports=undefined,require=function(e){var t=e.split("/"),n="plenluno.orb",r=t.length;for(var i=0;i<r;i++)t[i]!="."&&t[i]!=".."&&(n+="."+t[i]);return namespace(n)};(function(e){"use strict";e.OK=[0,"OK"],e.ANY=[1,""],e.TIMEOUT=[2,"Timeout"],e.ILLEGAL_ARGUMENT=[3,"Illegal Argument"],e.ILLEGAL_DATA_FORMAT=[4,"Illegal Data Format"],e.ILLEGAL_REQUEST=[5,"Illegal Request"],e.ILLEGAL_RESPONSE=[6,"Illegal Response"],e.ILLEGAL_STATE=[7,"Illegal State"],e.ILLEGAL_TYPE=[8,"Illegal Type"],e.INDEX_OUT_OF_BOUNDS=[9,"Index Out Of Bounds"],e.NO_SUCH_ELEMENT=[10,"No Such Element"],e.NO_SUCH_FIELD=[11,"No Such Field"],e.NO_SUCH_METHOD=[12,"No Such Method"],e.NULL=[13,"Null"],e.UNSUPPORTED_VERSION=[14,"Unsupported Version"],e.UNSUPPORTED_OPERATION=[15,"Unsupported Operation"]})(typeof exports=="undefined"?namespace("plenluno.orb.error.common"):exports),function(e){"use strict";e.BAD_REQUEST=[400,"Bad Request"],e.UNAUTHORIZED=[401,"Unauthorized"],e.PAYMENT_REQUIRED=[402,"Payment Required"],e.FORBIDDEN=[403,"Forbidden"],e.NOT_FOUND=[404,"Not Found"],e.METHOD_NOT_ALLOWED=[405,"Method Not Allowed"],e.NOT_ACCEPTABLE=[406,"Not Acceptable"],e.PROXY_AUTHENTICATION_REQUIRED=[407,"Proxy Authentication Required"],e.REQUEST_TIMEOUT=[408,"Request Timeout"],e.CONFLICT=[409,"Conflict"],e.GONE=[410,"Gone"],e.LENGTH_REQUIRED=[411,"Length Required"],e.PRECONDITION_FAILED=[412,"Precondition Failed"],e.REQUEST_ENTITY_TOO_LARGE=[413,"Request Entity Too Large"],e.REQUEST_URI_TOO_LONG=[414,"Request-URI Too Long"],e.UNSUPPORTED_MEDIA_TYPE=[415,"Unsupported Media Type"],e.REQUESTED_RANGE_NOT_SATISFIABLE=[416,"Requested Range Not Satisfiable"],e.EXPECTATION_FAILED=[417,"Expectation Failed"],e.INTERNAL_SERVER_ERROR=[500,"Internal Server Error"],e.NOT_IMPLEMENTED=[501,"Not Implemented"],e.BAD_GATEWAY=[502,"Bad Gateway"],e.SERVICE_UNAVAILABLE=[503,"Service Unavailable"],e.GATEWAY_TIMEOUT=[504,"Gateway Timeout"],e.HTTP_VERSION_NOT_SUPPORTED=[505,"HTTP Version Not Supported"]}(typeof exports=="undefined"?namespace("plenluno.orb.error.http"):exports),function(e){"use strict";var t=function(){};e.create=function(){var e={};return e.name=null,e.serialize=t,e.deserialize=t,e.support=t,e}}(typeof exports=="undefined"?namespace("plenluno.orb.serializer"):exports),function(e){"use strict";var t=function(e){return e=="http"||e=="loopback"||e=="socketio"||e=="websocket"||e=="xhrget"||e=="xhrpost"};e.create=function(){var e=function(e){return JSON.stringify(e)},n=function(e){return JSON.parse(e)},r=require("./serializer").create();return Object.defineProperties(r,{name:{value:"jsonizer",writable:!1,configurable:!1},serialize:{value:e,writable:!1,configurable:!1},deserialize:{value:n,writable:!1,configurable:!1},support:{value:t,writable:!1,configurable:!1}}),r},e.support=t}(typeof exports=="undefined"?namespace("plenluno.orb.serializer.jsonizer"):exports),function(e){"use strict";var t=function(e){return e=="loopback"};e.create=function(){var e=require("../util/assert").create(),n=function(t){e(typeof t=="object");var n="";for(var r in t)n&&(n+="&"),n+=r+"="+encodeURI(JSON.stringify(t[r]));return n},r=require("../../deps/parseuri").parse,i=function(t){e(typeof t=="string");var n=r("/?"+t,!0).queryKey,i={};for(var s in n){var o=decodeURI(n[s]);try{i[s]=JSON.parse(o)}catch(u){i[s]=o}}return i},s=require("./serializer").create();return Object.defineProperties(s,{name:{value:"querizer",writable:!1,configurable:!1},serialize:{value:n,writable:!1,configurable:!1},deserialize:{value:i,writable:!1,configurable:!1},support:{value:t,writable:!1,configurable:!1}}),s},e.support=t}(typeof exports=="undefined"?namespace("plenluno.orb.serializer.querizer"):exports),function(e){"use strict";var t=function(){};e.create=function(){var e={};return e.name=null,e.transform=t,e.untransform=t,e}}(typeof exports=="undefined"?namespace("plenluno.orb.style"):exports),function(e){"use strict";e.create=function(){var e=function(e,t){return t},t=function(e,t){return t},n=require("./style").create();return Object.defineProperties(n,{name:{value:"default",writable:!1,configurable:!1},transform:{value:e,writable:!1,configurable:!1},untransform:{value:t,writable:!1,configurable:!1}}),n}}(typeof exports=="undefined"?namespace("plenluno.orb.style.default"):exports),function(e){"use strict";var t=function(){},n=function(){return!1};e.create=function(){var e={};return e.name=null,e.open=t,e.close=t,e.isOpen=n,e.send=t,e.support=n,e.onOpen=t,e.onClose=t,e.onError=t,e.onReceive=t,e}}(namespace("plenluno.orb.client.transport")),namespace("plenluno.orb.client.transport.xhrpost").create=function(e){"use strict";var t=Function("return this")(),n=t.plenluno.orb.util.assert.create();n(typeof e=="object"),n(typeof e.url=="string"),n(typeof e.serializer=="string");var r=e.url,i=e.serializer,s=t.plenluno.orb.client.transport.create(),o=0,u=[],a=function(e){return function(){u[e].abort(),delete u[e]}},f=function(e){return function(){var t=u[e];t&&t.readyState===4&&(s.onReceive(t.responseText),delete u[e])}},l=!1,c=function(){return l},h=function(e){e&&(n(typeof e=="object"),e.onOpen&&(s.onOpen=e.onOpen),e.onError&&(s.onError=e.onError)),n(typeof s.onOpen=="function"),n(typeof s.onError=="function"),l||(l=!0,s.onOpen())},p=function(){e&&(n(typeof e=="object"),e.onClose&&(s.onClose=e.onClose),e.onError&&(s.onError=e.onError)),n(typeof s.onClose=="function"),n(typeof s.onError=="function"),l&&(l=!1,s.onClose())},d=function(e,t){if(!l)return;var n=new XMLHttpRequest;u[o]=n,n.ontimeout=a(o),n.onreadystatechange=f(o),n.open("POST",r,!0),n.timeout=t,n.withCredentials=!0,i.name==="jsonizer"&&n.setRequestHeader("Content-Type","application/json; charset=UTF-8"),n.send(e),o++},v=function(e){return t.plenluno.orb.serializer[e].support("xhrpost")};return Object.defineProperties(s,{name:{value:"xhrpost",writable:!1,configurable:!1},open:{value:h,writable:!1,configurable:!1},close:{value:p,writable:!1,configurable:!1},isOpen:{value:c,writable:!1,configurable:!1},send:{value:d,writable:!1,configurable:!1},support:{value:v,writable:!1,configurable:!1}}),s},namespace("plenluno.orb.client.transport.socketio").create=function(e){"use strict";var t=Function("return this")(),n=t.plenluno.orb.util.assert.create();n(typeof e=="object"),n(typeof e.url=="string");var r=e.url,i=t.plenluno.orb.client.transport.create(),s=null,o=!1,u=function(e){e&&(n(typeof e=="object"),e.onOpen&&(i.onOpen=e.onOpen),e.onError&&(i.onError=e.onError)),n(typeof i.onOpen=="function"),n(typeof i.onError=="function"),s||(s=io.connect(r),s.on("connect",function(){o=!0,i.onOpen.apply(i.onOpen,arguments)}),s.on("disconnect",function(){i.onClose.apply(i.onClose,arguments)}),s.on("message",function(){var e=i.onReceive;n(typeof e=="function"),e.apply(e,arguments)}))},a=function(e){e&&(n(typeof e=="object"),e.onClose&&(i.onClose=e.onClose),e.onError&&(i.onError=e.onError)),n(typeof i.onClose=="function"),n(typeof i.onError=="function"),s&&(s.disconnect(),s=null)},o=function(){return o},f=function(e){s&&o&&s.send(e)},l=function(e){return t.plenluno.orb.serializer[e].support("socketio")};return Object.defineProperties(i,{name:{value:"socketio",writable:!1,configurable:!1},open:{value:u,writable:!1,configurable:!1},close:{value:a,writable:!1,configurable:!1},isOpen:{value:o,writable:!1,configurable:!1},send:{value:f,writable:!1,configurable:!1},support:{value:l,writable:!1,configurable:!1}}),i},namespace("plenluno.orb.client.service").create=function(e){"use strict";var t=Function("return this")(),n=t.plenluno.orb.util.assert.create();n(typeof e=="object");var r=e.guide?e.guide+"/guide":e.url,i=e.mode||"release";n(typeof r=="string"),n(typeof i=="string");var s=e.style||"default",o,u;e.guide?(n(!e.transport||e.transport=="xhrpost"),n(!e.serializer||e.serializer=="jsonizer"),o="xhrpost",u="jsonizer"):(o=e.transport,u=e.serializer),n(typeof s=="string"),n(typeof o=="string"),n(typeof u=="string");var a=t.plenluno.orb.style[s].create(),f=t.plenluno.orb.serializer[u].create(),l=t.plenluno.orb.client.transport[o].create({url:r,serializer:u});n(typeof a=="object"),n(typeof l=="object"),n(typeof f=="object"),n(l.support(u)),n(f.support(o));var c=0,h={},p={},d={},v={},m={},g={},y=function(){},b=function(e){delete m[e],delete g[e],delete v[e],d[e]&&clearTimeout(d[e])},w=t.plenluno.orb.error.common,E=function(e){clearTimeout(d[e]),d[e]=setTimeout(function(){var t=g[e];typeof t=="string"&&(t=h[t]),t&&(n(typeof t=="function"),t.apply(t,w.TIMEOUT)),b(e)},v[e])},S=t.plenluno.orb.serializer.querizer.create(),x=function(e){n(typeof e=="object"),n(typeof e.method=="string"),n(e.params instanceof Array),n(!e.callbacks||typeof e.callbacks=="object"),n(!e.callbacks.onResult||typeof e.callbacks.onResult=="string"||typeof e.callbacks.onResult=="function"),n(!e.callbacks.onStatus||typeof e.callbacks.onStatus=="string"||typeof e.callbacks.onStatus=="function"),n(!e.timeout||typeof e.timeout=="number"),n(!e.version||typeof e.version=="string");do c++,c>2147483647&&(c=1);while(m[c]);n(!g[c]&&!d[c]&&!v[c]),e.callbacks&&(m[c]=e.callbacks.onResult||y,g[c]=e.callbacks.onStatus||y);var t={method:e.method,params:e.params,id:c};e.version&&(t.version=e.version),t=a.transform("request",t);var r;l.name=="xhrget"?r=S.serialize(t):r=f.serialize(t);var i=e.timeout||0;i=i>=100?i:0,i&&(v[c]=i,E(c)),l.send(r,i)},T=function(e){if(e instanceof Array){for(var t=0;t<e.length;t++)T.call(this,e[t]);return}n(typeof e=="object");var r;if(e.method){n(typeof e.method=="string"),n(!e.timeout||typeof e.timeout=="number"),n(!e.version||typeof e.version=="string"),r=e.method;var i=e.params,s=e.result,o=e.timeout,u=e.version;p[r]={params:i,result:s,timeout:o,version:u},this[r]=function(){n(arguments.length==i.length+1);var e=Array.prototype.pop.apply(arguments),t=[];for(var s=0;s<arguments.length;s++)t.push(arguments[s]);x({method:r,params:t,callbacks:e,timeout:o,version:u})}}else if(e.callback){n(typeof e.callback=="string"),n(typeof e.functor=="function"),r=e.callback;var a=e.functor;r=="onOpen"?l.onOpen=a:r=="onClose"?l.onClose=a:h[r]=a}},N=function(e){var t=e;return typeof t=="string"&&(t=h[t]),t&&n(typeof t=="function"),t},C=function(e,t){e&&(t instanceof Array?e.apply(e,t):e.apply(e,[t]))};l.onReceive=function(e){var t=a.untransform("response",f.deserialize(e));n(typeof t=="object"),n(!t.result||t.result instanceof Array),n(!t.results||t.results instanceof Array),n(!t.status||!t.next&&t.status instanceof Array&&t.status.length==2&&typeof t.status[0]=="number"&&typeof t.status[1]=="string"),n(!t.error||!t.next&&t.error instanceof Array&&t["error"].length==2&&typeof t["error"][0]=="number"&&typeof t["error"][1]=="string");var r=t.id,i;if(t.result)i=N(m[r]),C(i,t.result);else if(t.results){i=N(m[r]);var s=t.results,o=s.length;for(var u=0;u<o;u++)C(i,s[u])}t.next?d[r]&&E(r):(i=N(g[r]),t.status?C(i,t.status):t.error?C(i,t.error):C(i,w.OK),b(r))};var k={};return Object.defineProperties(k,{open:{value:l.open,writable:!1,configurable:!1},close:{value:l.close,writable:!1,configurable:!1},call:{value:x,writable:!1,configurable:!1},register:{value:T,writable:!1,configurable:!1}}),e.guide&&k.register({method:"getServiceProtocols",params:["string"],result:['{"url":"string","transport":"string","serializer":"string"}*']}),i=="debug"&&Object.defineProperties(k,{transport:{value:l,writable:!1,configurable:!1},callbacks:{value:h,writable:!1,configurable:!1},methodTypes:{value:p,writable:!1,configurable:!1}}),k};